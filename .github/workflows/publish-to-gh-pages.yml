name: build-and-upload-to-gh-pages
# This workflow builds the Kodi plugin and uploads it to the gh-pages branch
# of the repository. It is triggered on pushes to the main and develop branches.
# It uses the actions/checkout action to check out the repository, and the
# peaceiris/actions-gh-pages action to publish the built plugin to the gh-pages branch.

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Uncomment when the KODI Repo Generator gets updated
      # - name: Checkout KODI Repo Generator
      #   uses: actions/checkout@v4
      #   with:
      #     repository: chadparry/kodi-repository.chad.parry.org
      #     ref: master
      #     path: kodi-repository-generator

      # - name: Copy needed file
      #   run: cp kodi-repository-generator/tools/create_repository.py ./tools/create_repository.py

      - name: Install dependencies
        run: pip3 install gitpython

      - name: Set branch-dependent environment variables
        id: setenv        
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            echo "PUBLISH_DIR=./gh-pages" >> $GITHUB_OUTPUT
            echo "INFO_URL=https://repository.kodi.reavey05.com/addons.xml" >> $GITHUB_OUTPUT
            echo "CHECKSUM_URL=https://repository.kodi.reavey05.com/addons.xml.sha256" >> $GITHUB_OUTPUT
            echo "DATADIR_URL=https://repository.kodi.reavey05.com/" >> $GITHUB_OUTPUT
          else
            echo "PUBLISH_DIR=./gh-pages/${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
            echo "INFO_URL=https://repository.kodi.reavey05.com/${GITHUB_REF##*/}/addons.xml" >> $GITHUB_OUTPUT
            echo "CHECKSUM_URL=https://repository.kodi.reavey05.com/${GITHUB_REF##*/}/addons.xml.sha256" >> $GITHUB_OUTPUT
            echo "DATADIR_URL=https://repository.kodi.reavey05.com/${GITHUB_REF##*/}/" >> $GITHUB_OUTPUT
          fi

      - name: Generate Repository
        run: |
          python3 ./tools/create_repository.py \
            --datadir=${{ steps.setenv.outputs.PUBLISH_DIR }} \
            repository.kodi.reavey05.com \
            https://github.com/brianpatrickreavey/kodi.plugin.video.angelstudios.git#${{ github.ref_name }}

      - name: Generate index.html
        run: python3 ./tools/generate_index.py ${{ steps.setenv.outputs.PUBLISH_DIR }}

      - name: List contents of publish directory
        run: |
          echo "Contents of ${{ steps.setenv.outputs.PUBLISH_DIR }} directory:"
          find ${{ steps.setenv.outputs.PUBLISH_DIR }}

      - name: Substitute variables in addon.xml
        run: |
          sed -i \
            -e "s|{{INFO_URL}}|${INFO_URL}|g" \
            -e "s|{{CHECKSUM_URL}}|${CHECKSUM_URL}|g" \
            -e "s|{{DATADIR_URL}}|${DATADIR_URL}|g" \
            repository.kodi.reavey05.com/addon.xml
        env:
          INFO_URL: ${{ steps.setenv.outputs.INFO_URL }}
          CHECKSUM_URL: ${{ steps.setenv.outputs.CHECKSUM_URL }}
          DATADIR_URL: ${{ steps.setenv.outputs.DATADIR_URL }}

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          cname: repository.kodi.reavey05.com
          keep_files: true
